<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Kasir</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>

<div class="container py-5">
    <div class="row">
        <h1>Halaman Kasir</h1>
        <div class="col">
            <form method="POST" id="transaction-form">
                <div class="mb-3">
                    <label for="card_number" class="form-label">Nomor Kartu Pelanggan:</label>
                    <input type="text" class="form-control" id="card_number" name="card_number" required>
                </div>
            
                <h2>Daftar Produk</h2>
                <table class="table" id="product-table">
                    <thead>
                        <tr>
                            <th>Nama Produk</th>
                            <th>Harga</th>
                            <th>Jumlah</th>
                            <th>Subtotal</th>
                            <th></th> 
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Baris produk akan ditambahkan di sini -->
                    </tbody>
                </table>
            
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" onclick="addProductRow()">Tambah Produk</button>
                </div>
            
                <div class="mb-3">
                    <h3>Total: <span id="total-price">0</span></h3>
                </div>

                <input type="hidden" name="transaction_data" id="transaction_data">
            
                <button type="submit" class="btn btn-primary">Proses Transaksi</button>
            </form>
        </div>
    </div>
</div>

<script>
    let productCount = 1;

    // Simpan data produk dalam variabel
    const products = {
        {% for product in products %}
            {{ product.id }}: {{ product.product_price }},
        {% endfor %}
    };

    function addProductRow() {
        const productTable = document.getElementById('product-table').getElementsByTagName('tbody')[0];
        const newRow = productTable.insertRow();

        // Nama Produk (Dropdown)
        const cell1 = newRow.insertCell();
        const productSelect = document.createElement('select');
        productSelect.className = 'form-select product-select';
        productSelect.name = `product_id-${productCount}`; 
        productSelect.required = true;

        let firstProductId = null; // Variabel untuk menyimpan ID produk pertama

        {% for product in products %}
            const option = document.createElement('option');
            option.value = {{ product.id }}; 
            option.text = `{{ product.product_name }}`;
            productSelect.add(option);

            // Set ID produk pertama jika belum ada
            if (firstProductId === null) {
                firstProductId = {{ product.id }};
            }
        {% endfor %}
        cell1.appendChild(productSelect);

        // Harga
        const cell2 = newRow.insertCell();
        cell2.className = 'product-price align-middle';

        // Set harga awal berdasarkan produk pertama yang dipilih
        cell2.innerHTML = products[firstProductId]; 

        // Jumlah
        const cell3 = newRow.insertCell();
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.className = 'form-control quantity-input';
        quantityInput.name = `quantity-${productCount}`;
        quantityInput.min = '1';
        quantityInput.value = '1';
        quantityInput.required = true;
        quantityInput.addEventListener('change', calculateSubtotal); 
        cell3.appendChild(quantityInput);

        // Subtotal
        const cell4 = newRow.insertCell();
        cell4.className = 'subtotal align-middle';
        cell4.innerHTML = '0';

        // Tombol Hapus
        const cell5 = newRow.insertCell();
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-danger btn-sm';
        deleteButton.innerHTML = 'Hapus';
        deleteButton.onclick = () => {
            productTable.deleteRow(newRow.rowIndex - 1);
            calculateTotal(); 
        };
        cell5.appendChild(deleteButton);

        productCount++;
        calculateTotal();

        // Event Listener untuk dropdown
        productSelect.addEventListener('change', (event) => {
            const row = event.target.closest('tr'); 
            const priceCell = row.querySelector('.product-price');
            const selectedProductId = event.target.value;
            const productPrice = products[selectedProductId];
            
            // Set harga produk yang benar ke priceCell (konversi ke angka)
            priceCell.innerHTML = parseFloat(productPrice); 
    
            // Panggil calculateSubtotal setelah harga di-update
            calculateSubtotal({ target: row.querySelector('.quantity-input') }); 
        });

        // Hitung subtotal awal saat baris ditambahkan
        calculateSubtotal({ target: quantityInput });
    }

    function calculateSubtotal(event) {
        const row = event.target.closest('tr');
        const price = parseFloat(row.querySelector('.product-price').innerHTML) || 0; // Pastikan price selalu berupa angka
        const quantity = parseInt(event.target.value) || 0; // Pastikan quantity selalu berupa angka
        const subtotal = price * quantity;
        row.querySelector('.subtotal').innerHTML = subtotal;
        calculateTotal();
    }

    function calculateTotal() {
        const subtotals = document.querySelectorAll('.subtotal');
        let totalPrice = 0;
        subtotals.forEach(subtotal => {
            totalPrice += parseFloat(subtotal.innerHTML) || 0; // Pastikan subtotal selalu berupa angka
        });
        document.getElementById('total-price').innerHTML = totalPrice;

        updateTransactionData();
    }

    function updateTransactionData() {
        const productRows = document.querySelectorAll('#product-table tbody tr');
        const transactionData = [];

        productRows.forEach(row => {
            const productId = row.querySelector('.product-select').value;
            const quantity = row.querySelector('.quantity-input').value;
            transactionData.push(`${productId}-${quantity}`);
        });

        document.getElementById('transaction_data').value = JSON.stringify(transactionData);
    }
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>